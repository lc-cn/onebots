<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneBots ç³»ç»Ÿæ¶æ„å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .diagram-section {
            margin: 30px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 5px;
        }
        .diagram-title {
            font-size: 20px;
            font-weight: bold;
            color: #444;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .export-buttons {
            text-align: center;
            margin: 20px 0;
        }
        .export-btn {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
        }
        .export-btn:hover {
            background: #45a049;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196F3;
            margin: 20px 0;
            border-radius: 4px;
        }
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .feature-item {
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .feature-item h3 {
            color: #4CAF50;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– OneBots ç³»ç»Ÿæ¶æ„å›¾</h1>
        
        <div class="info-box">
            <strong>æç¤ºï¼š</strong>å³é”®ç‚¹å‡»å›¾è¡¨å¯ä»¥ä¿å­˜ä¸ºPNGæˆ–SVGæ ¼å¼ã€‚æˆ–è€…ä½¿ç”¨ä¸‹æ–¹çš„å¯¼å‡ºæŒ‰é’®ã€‚
        </div>

        <div class="export-buttons">
            <button class="export-btn" onclick="exportAllAsPNG()">ğŸ“· å¯¼å‡ºæ‰€æœ‰ä¸ºPNG</button>
            <button class="export-btn" onclick="exportAllAsSVG()">ğŸ¨ å¯¼å‡ºæ‰€æœ‰ä¸ºSVG</button>
        </div>

        <!-- æ•´ä½“æ¶æ„å›¾ -->
        <div class="diagram-section">
            <div class="diagram-title">1ï¸âƒ£ æ•´ä½“ç³»ç»Ÿæ¶æ„</div>
            <div class="mermaid">
graph TB
    subgraph APP["ğŸ¢ åº”ç”¨å±‚ (App Layer)"]
        App["App<br/>ğŸ“¦ Koa Application<br/>- é…ç½®ç®¡ç†<br/>- æ—¥å¿—ç³»ç»Ÿ<br/>- HTTP/WSæœåŠ¡å™¨<br/>- è·¯ç”±ç®¡ç†"]
    end

    subgraph ADAPTERS["ğŸ”Œ å¹³å°é€‚é…å™¨å±‚ (Adapter Layer)"]
        QQAdapter["QQ Adapter<br/>ğŸ“± qq-official-bot<br/>- äº‹ä»¶æå–<br/>- åŠ¨ä½œæ‰§è¡Œ"]
        WeChatAdapter["WeChat Adapter<br/>ğŸ’¬ WeChat Web<br/>- äº‹ä»¶æå–<br/>- åŠ¨ä½œæ‰§è¡Œ"]
        DingTalkAdapter["DingTalk Adapter<br/>ğŸ“§ DingTalk SDK<br/>- äº‹ä»¶æå–<br/>- åŠ¨ä½œæ‰§è¡Œ"]
    end

    subgraph ACCOUNTS["ğŸ‘¤ è´¦å·å±‚ (Account Layer)"]
        Account1["Account<br/>ğŸ†” qq.123456<br/>- status: online<br/>- protocols: []"]
        Account2["Account<br/>ğŸ†” wechat.bot001<br/>- status: online<br/>- protocols: []"]
    end

    subgraph PROTOCOLS["ğŸ“¡ åè®®å±‚ (Protocol Layer)"]
        OneBotV11["OneBot V11<br/>ğŸ”— /qq/123456/onebot/v11<br/>- HTTP Server<br/>- WebSocket<br/>- äº‹ä»¶è½¬æ¢"]
        OneBotV12["OneBot V12<br/>ğŸ”— /qq/123456/onebot/v12<br/>- HTTP Server<br/>- WebSocket<br/>- äº‹ä»¶è½¬æ¢"]
        Satori["Satori V1<br/>ğŸ”— /qq/123456/satori/v1<br/>- è·¨å¹³å°æ”¯æŒ<br/>- ç»Ÿä¸€API"]
        Milky["Milky V1<br/>ğŸ”— /qq/123456/milky/v1<br/>- QQä¸“ç”¨åè®®"]
    end

    subgraph CLIENTS["ğŸ’» å®¢æˆ·ç«¯"]
        Client1["HTTP Client"]
        Client2["WebSocket Client"]
    end

    App --> QQAdapter
    App --> WeChatAdapter
    App --> DingTalkAdapter
    
    QQAdapter --> Account1
    WeChatAdapter --> Account2
    
    Account1 --> OneBotV11
    Account1 --> OneBotV12
    Account1 --> Satori
    Account1 --> Milky
    
    OneBotV11 --> Client1
    OneBotV12 --> Client2
    Satori --> Client1
    
    style App fill:#4CAF50,stroke:#333,stroke-width:2px,color:#fff
    style QQAdapter fill:#2196F3,stroke:#333,stroke-width:2px,color:#fff
    style WeChatAdapter fill:#2196F3,stroke:#333,stroke-width:2px,color:#fff
    style DingTalkAdapter fill:#2196F3,stroke:#333,stroke-width:2px,color:#fff
    style Account1 fill:#FF9800,stroke:#333,stroke-width:2px,color:#fff
    style Account2 fill:#FF9800,stroke:#333,stroke-width:2px,color:#fff
    style OneBotV11 fill:#9C27B0,stroke:#333,stroke-width:2px,color:#fff
    style OneBotV12 fill:#9C27B0,stroke:#333,stroke-width:2px,color:#fff
    style Satori fill:#9C27B0,stroke:#333,stroke-width:2px,color:#fff
    style Milky fill:#9C27B0,stroke:#333,stroke-width:2px,color:#fff
            </div>
        </div>

        <!-- æ•°æ®æµå‘å›¾ -->
        <div class="diagram-section">
            <div class="diagram-title">2ï¸âƒ£ æ•°æ®æµå‘å›¾</div>
            <div class="mermaid">
graph LR
    subgraph UP["â¬†ï¸ ä¸Šè¡Œæµç¨‹ï¼šå¹³å°äº‹ä»¶ â†’ åè®®äº‹ä»¶"]
        A1["å¹³å°åŸå§‹äº‹ä»¶<br/>QQ/WeChat/DingTalk"] --> A2["Adapter<br/>extractEvent()"]
        A2 --> A3["Account<br/>dispatch()"]
        A3 --> A4["Protocol<br/>format()"]
        A4 --> A5["åè®®æ ‡å‡†æ ¼å¼<br/>OneBot/Satori"]
        A5 --> A6["å®¢æˆ·ç«¯æ¥æ”¶<br/>HTTP/WebSocket"]
    end

    subgraph DOWN["â¬‡ï¸ ä¸‹è¡Œæµç¨‹ï¼šAPIè°ƒç”¨ â†’ å¹³å°åŠ¨ä½œ"]
        B1["å®¢æˆ·ç«¯è¯·æ±‚<br/>HTTP/WebSocket"] --> B2["Protocol<br/>apply()"]
        B2 --> B3["Adapter<br/>executeAction()"]
        B3 --> B4["å¹³å°SDKæ‰§è¡Œ<br/>å‘é€æ¶ˆæ¯ç­‰"]
    end

    style A1 fill:#e3f2fd,stroke:#2196F3,stroke-width:2px
    style A2 fill:#fff3e0,stroke:#FF9800,stroke-width:2px
    style A3 fill:#fce4ec,stroke:#E91E63,stroke-width:2px
    style A4 fill:#f3e5f5,stroke:#9C27B0,stroke-width:2px
    style A5 fill:#e8f5e9,stroke:#4CAF50,stroke-width:2px
    style A6 fill:#e0f2f1,stroke:#009688,stroke-width:2px
    
    style B1 fill:#e0f2f1,stroke:#009688,stroke-width:2px
    style B2 fill:#f3e5f5,stroke:#9C27B0,stroke-width:2px
    style B3 fill:#fff3e0,stroke:#FF9800,stroke-width:2px
    style B4 fill:#e3f2fd,stroke:#2196F3,stroke-width:2px
            </div>
        </div>

        <!-- ç±»å…³ç³»å›¾ -->
        <div class="diagram-section">
            <div class="diagram-title">3ï¸âƒ£ æ ¸å¿ƒç±»å…³ç³»å›¾</div>
            <div class="mermaid">
classDiagram
    class App {
        +Map~string,Adapter~ adapters
        +Router router
        +Config config
        +Logger logger
        +start()
        +stop()
        +registerAdapter()
        +getLogger()
    }

    class Adapter {
        <<abstract>>
        +string platform
        +Map~string,Account~ accounts
        +App app
        +createAccount()
        +sendMessage()
        +getMessage()
        +getFriendList()
        +getGroupList()
    }

    class Account {
        +string account_id
        +string platform
        +AccountStatus status
        +Protocol[] protocols
        +Adapter adapter
        +start()
        +stop()
        +dispatch()
    }

    class Protocol {
        <<abstract>>
        +string name
        +string version
        +Adapter adapter
        +Account account
        +start()
        +stop()
        +dispatch()
        +format()
        +apply()
        +filterFn()
    }

    class OneBotV11 {
        +name: "onebot"
        +version: "v11"
        +V11Service service
        +start()
        +stop()
    }

    class OneBotV12 {
        +name: "onebot"
        +version: "v12"
        +V12Service service
        +start()
        +stop()
    }

    class ProtocolRegistry {
        <<singleton>>
        +Map protocols
        +register()
        +create()
        +has()
    }

    App "1" --> "*" Adapter : manages
    Adapter "1" --> "*" Account : manages
    Account "1" --> "*" Protocol : has
    Protocol <|-- OneBotV11 : implements
    Protocol <|-- OneBotV12 : implements
    ProtocolRegistry ..> Protocol : creates
            </div>
        </div>

        <!-- URLè·¯ç”±ç»“æ„ -->
        <div class="diagram-section">
            <div class="diagram-title">4ï¸âƒ£ URL è·¯ç”±ç»“æ„</div>
            <div class="mermaid">
graph TD
    ROOT["æ ¹è·¯å¾„ /"] --> PLATFORM["å¹³å°å±‚<br/>/{platform}"]
    
    PLATFORM --> QQ["QQ<br/>/qq"]
    PLATFORM --> WECHAT["WeChat<br/>/wechat"]
    PLATFORM --> DINGTALK["DingTalk<br/>/dingtalk"]
    
    QQ --> ACCOUNT1["è´¦å·å±‚<br/>/qq/{account_id}"]
    ACCOUNT1 --> PROTO1["åè®®å±‚<br/>/qq/123456/{protocol}"]
    
    PROTO1 --> ONEBOT["OneBot<br/>/qq/123456/onebot"]
    PROTO1 --> SATORI_P["Satori<br/>/qq/123456/satori"]
    PROTO1 --> MILKY_P["Milky<br/>/qq/123456/milky"]
    
    ONEBOT --> V11["ç‰ˆæœ¬å±‚<br/>/qq/123456/onebot/v11"]
    ONEBOT --> V12["/qq/123456/onebot/v12"]
    
    V11 --> ACTION1["åŠ¨ä½œå±‚<br/>/qq/123456/onebot/v11/send_private_msg"]
    V11 --> ACTION2["/qq/123456/onebot/v11/get_friend_list"]
    V11 --> WS1["WebSocket<br/>ws://...../qq/123456/onebot/v11"]
    
    V12 --> ACTION3["/qq/123456/onebot/v12/send_message"]
    V12 --> ACTION4["/qq/123456/onebot/v12/get_login_info"]
    
    style ROOT fill:#4CAF50,stroke:#333,stroke-width:3px,color:#fff
    style PLATFORM fill:#2196F3,stroke:#333,stroke-width:2px,color:#fff
    style QQ fill:#FF9800,stroke:#333,stroke-width:2px,color:#fff
    style WECHAT fill:#FF9800,stroke:#333,stroke-width:2px,color:#fff
    style DINGTALK fill:#FF9800,stroke:#333,stroke-width:2px,color:#fff
    style ACCOUNT1 fill:#9C27B0,stroke:#333,stroke-width:2px,color:#fff
    style PROTO1 fill:#E91E63,stroke:#333,stroke-width:2px,color:#fff
    style ONEBOT fill:#00BCD4,stroke:#333,stroke-width:2px,color:#fff
    style V11 fill:#009688,stroke:#333,stroke-width:2px,color:#fff
    style V12 fill:#009688,stroke:#333,stroke-width:2px,color:#fff
            </div>
        </div>

        <!-- åè®®æ³¨å†Œæµç¨‹ -->
        <div class="diagram-section">
            <div class="diagram-title">5ï¸âƒ£ åè®®æ³¨å†Œä¸å®ä¾‹åŒ–æµç¨‹</div>
            <div class="mermaid">
sequenceDiagram
    participant App
    participant Adapter
    participant Account
    participant Registry as ProtocolRegistry
    participant Protocol

    App->>Adapter: åˆ›å»ºå¹³å°é€‚é…å™¨
    activate Adapter
    Adapter->>App: æ³¨å†Œé€‚é…å™¨
    deactivate Adapter

    App->>Adapter: æ ¹æ®é…ç½®åˆ›å»ºè´¦å·
    activate Adapter
    Adapter->>Account: new Account(account_id, config)
    activate Account
    
    Account->>Account: è§£æåè®®é…ç½®
    Note over Account: onebot.v11<br/>onebot.v12<br/>satori.v1
    
    loop æ¯ä¸ªåè®®é…ç½®
        Account->>Registry: create(protocol, version, ...)
        activate Registry
        Registry->>Protocol: new Protocol(adapter, account, config)
        activate Protocol
        Protocol-->>Registry: protocolå®ä¾‹
        deactivate Protocol
        Registry-->>Account: protocolå®ä¾‹
        deactivate Registry
        Account->>Account: protocols.push(protocol)
    end
    
    Account->>Protocol: start() å¯åŠ¨æ‰€æœ‰åè®®
    activate Protocol
    Protocol->>Protocol: å¯åŠ¨HTTPæœåŠ¡
    Protocol->>Protocol: å¯åŠ¨WebSocketæœåŠ¡
    Protocol-->>Account: å¯åŠ¨å®Œæˆ
    deactivate Protocol
    
    Account-->>Adapter: è´¦å·åˆ›å»ºå®Œæˆ
    deactivate Account
    Adapter-->>App: é€‚é…å™¨å°±ç»ª
            </div>
        </div>

        <!-- äº‹ä»¶å¤„ç†æµç¨‹ -->
        <div class="diagram-section">
            <div class="diagram-title">6ï¸âƒ£ äº‹ä»¶å¤„ç†æµç¨‹ï¼ˆä¸Šè¡Œï¼‰</div>
            <div class="mermaid">
sequenceDiagram
    participant SDK as å¹³å°SDK
    participant Adapter
    participant Account
    participant Protocol
    participant Client as å®¢æˆ·ç«¯

    SDK->>Adapter: åŸå§‹äº‹ä»¶<br/>(message, notice, request)
    activate Adapter
    Note over Adapter: æå–é€šç”¨äº‹ä»¶ç»“æ„
    Adapter->>Account: dispatch(event)
    deactivate Adapter
    
    activate Account
    Note over Account: åˆ†å‘ç»™æ‰€æœ‰åè®®
    loop æ¯ä¸ªProtocol
        Account->>Protocol: dispatch(event)
        activate Protocol
        
        Protocol->>Protocol: filterFn(event)<br/>äº‹ä»¶è¿‡æ»¤
        
        alt é€šè¿‡è¿‡æ»¤å™¨
            Protocol->>Protocol: format(event)<br/>è½¬æ¢ä¸ºåè®®æ ¼å¼
            Note over Protocol: OneBot V11/V12<br/>Satori<br/>Milky
            
            Protocol->>Client: HTTP Post / WebSocket Push
            Note over Protocol,Client: æ¨é€åˆ°å®¢æˆ·ç«¯
            
            Client-->>Protocol: å¿«é€Ÿæ“ä½œå“åº”(å¯é€‰)
            Protocol->>Adapter: executeAction(quickOp)
        end
        
        deactivate Protocol
    end
    deactivate Account
            </div>
        </div>

        <!-- APIè°ƒç”¨æµç¨‹ -->
        <div class="diagram-section">
            <div class="diagram-title">7ï¸âƒ£ API è°ƒç”¨æµç¨‹ï¼ˆä¸‹è¡Œï¼‰</div>
            <div class="mermaid">
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Router
    participant Protocol
    participant Adapter
    participant SDK as å¹³å°SDK

    Client->>Router: POST /qq/123456/onebot/v11/send_private_msg
    activate Router
    Note over Router: è§£æURL<br/>platform=qq<br/>account_id=123456<br/>protocol=onebot<br/>version=v11
    
    Router->>Protocol: apply(action, params)
    deactivate Router
    
    activate Protocol
    Note over Protocol: éªŒè¯è®¿é—®ä»¤ç‰Œ<br/>å‚æ•°æ ¡éªŒ
    
    Protocol->>Protocol: è½¬æ¢å‚æ•°æ ¼å¼
    Note over Protocol: OneBotæ ¼å¼ â†’ å¹³å°æ ¼å¼
    
    Protocol->>Adapter: sendMessage(user_id, message)
    deactivate Protocol
    
    activate Adapter
    Adapter->>SDK: è°ƒç”¨å¹³å°SDK
    activate SDK
    SDK-->>Adapter: è¿”å›ç»“æœ
    deactivate SDK
    
    Adapter-->>Protocol: è¿”å›ç»“æœ
    deactivate Adapter
    
    activate Protocol
    Protocol->>Protocol: æ ¼å¼åŒ–è¿”å›å€¼
    Protocol-->>Client: JSONå“åº”
    deactivate Protocol
    
    Note over Client: {<br/>  "status": "ok",<br/>  "retcode": 0,<br/>  "data": {...}<br/>}
            </div>
        </div>

        <!-- ç‰¹æ€§åˆ—è¡¨ -->
        <div class="diagram-section">
            <div class="diagram-title">âœ¨ æ ¸å¿ƒç‰¹æ€§</div>
            <div class="feature-list">
                <div class="feature-item">
                    <h3>ğŸŒ å¤šå¹³å°æ”¯æŒ</h3>
                    <ul>
                        <li>QQå®˜æ–¹æœºå™¨äºº</li>
                        <li>å¾®ä¿¡ (Web/Official)</li>
                        <li>é’‰é’‰</li>
                        <li>æ˜“äºæ‰©å±•æ–°å¹³å°</li>
                    </ul>
                </div>
                
                <div class="feature-item">
                    <h3>ğŸ“¡ å¤šåè®®æ”¯æŒ</h3>
                    <ul>
                        <li>OneBot V11 æ ‡å‡†</li>
                        <li>OneBot V12 æ ‡å‡†</li>
                        <li>Satori è·¨å¹³å°åè®®</li>
                        <li>Milky QQåè®®</li>
                    </ul>
                </div>
                
                <div class="feature-item">
                    <h3>ğŸ”„ å¤šå®ä¾‹è¿è¡Œ</h3>
                    <ul>
                        <li>åŒä¸€è´¦å·å¤šåè®®å¹¶å­˜</li>
                        <li>å¤šè´¦å·ç‹¬ç«‹ç®¡ç†</li>
                        <li>çµæ´»çš„é…ç½®ç³»ç»Ÿ</li>
                    </ul>
                </div>
                
                <div class="feature-item">
                    <h3>ğŸš€ é«˜æ€§èƒ½</h3>
                    <ul>
                        <li>Node.js å¼‚æ­¥æ¶æ„</li>
                        <li>å†…ç½® SQLite æ•°æ®åº“</li>
                        <li>WebSocket å®æ—¶é€šä¿¡</li>
                        <li>äº‹ä»¶è¿‡æ»¤ä¼˜åŒ–</li>
                    </ul>
                </div>
                
                <div class="feature-item">
                    <h3>ğŸ› ï¸ æ˜“äºæ‰©å±•</h3>
                    <ul>
                        <li>æ¸…æ™°çš„åˆ†å±‚æ¶æ„</li>
                        <li>åè®®æ³¨å†Œæœºåˆ¶</li>
                        <li>æ’ä»¶åŒ–è®¾è®¡</li>
                        <li>TypeScript ç±»å‹æ”¯æŒ</li>
                    </ul>
                </div>
                
                <div class="feature-item">
                    <h3>ğŸ” å®‰å…¨å¯é </h3>
                    <ul>
                        <li>è®¿é—®ä»¤ç‰ŒéªŒè¯</li>
                        <li>CORS è·¨åŸŸæ§åˆ¶</li>
                        <li>å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿ</li>
                        <li>ä¼˜é›…åœæœºæœºåˆ¶</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });

        // å¯¼å‡ºä¸ºPNG
        async function exportAllAsPNG() {
            const diagrams = document.querySelectorAll('.mermaid');
            for (let i = 0; i < diagrams.length; i++) {
                const svg = diagrams[i].querySelector('svg');
                if (svg) {
                    await exportSVGtoPNG(svg, `onebots-architecture-${i + 1}.png`);
                }
            }
            alert('æ‰€æœ‰å›¾è¡¨å·²å¯¼å‡ºä¸ºPNGæ ¼å¼ï¼');
        }

        // å¯¼å‡ºä¸ºSVG
        function exportAllAsSVG() {
            const diagrams = document.querySelectorAll('.mermaid');
            diagrams.forEach((diagram, i) => {
                const svg = diagram.querySelector('svg');
                if (svg) {
                    const serializer = new XMLSerializer();
                    const source = serializer.serializeToString(svg);
                    const blob = new Blob([source], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `onebots-architecture-${i + 1}.svg`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });
            alert('æ‰€æœ‰å›¾è¡¨å·²å¯¼å‡ºä¸ºSVGæ ¼å¼ï¼');
        }

        // SVGè½¬PNG
        function exportSVGtoPNG(svg, filename) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const svgData = new XMLSerializer().serializeToString(svg);
                const img = new Image();
                
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = function() {
                    canvas.width = img.width * 2; // 2x for better quality
                    canvas.height = img.height * 2;
                    ctx.scale(2, 2);
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    canvas.toBlob(function(blob) {
                        const pngUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = pngUrl;
                        a.download = filename;
                        a.click();
                        URL.revokeObjectURL(pngUrl);
                        URL.revokeObjectURL(url);
                        resolve();
                    });
                };
                
                img.src = url;
            });
        }

        // æ·»åŠ å³é”®èœå•ä¿å­˜åŠŸèƒ½
        document.querySelectorAll('.mermaid').forEach(diagram => {
            diagram.addEventListener('contextmenu', function(e) {
                // å…è®¸æµè§ˆå™¨é»˜è®¤çš„å³é”®èœå•ï¼Œæ–¹ä¾¿ä¿å­˜å›¾ç‰‡
            });
        });
    </script>
</body>
</html>
